var HLSJSAPI={Version:"0.8.8b",ReleaseDate:"2018/11/01",Finish:""};HLSJSAPI.Class=function(){console.log("Version:["+HLSJSAPI.Version+"] Release Date:["+HLSJSAPI.ReleaseDate+"]");var a=function(d){var e=this;this.option=d||{};this.Player=null;this.vendorHidden;this.vendorVisibilityChange;this.url=null;this.hls=null;this.doSeek;this.playState=null;this.ready=null;this.network=null;this.bufferTime=0,this.currentTime=0,this.delayTime=0,this.seekTime=0,this.times=0,this.lastTime=0,this.seekableEnd=0,this.lastBuffer=0,this.lastCurrent=0,this.readyTimes=0,this.bufferTimes=0,this.currentStopTimes=0;this.maniLoading=0,this.maniLoaded=0,this.maniInitPTS=0,this.maniPaesed=0,this.fragParsingInit=0;this.errorcode="";this.timecode=null,this.timeStamp=null,this.lastFragInterval=null,this.m3u8modify=null;this.iOS=!!navigator.platform&&/iPad|iPhone|iPod/.test(navigator.platform);this.userAgent=navigator.userAgent;this.streamaSwitch=true;this.lastSoundState=null;this.hlsHidden=false;this.manipause=false;this.inSeek=false;this.m3u8get=null,this.m3u8Url=null;this.lastbasechk="",this.basechk="",this.basechktimes=0,this.lastclientTime=0;this.errDetails="",this.updateTimes=0;this.seekType=typeof this.option.seekType!="undefined"?this.option.seekType:"disable";this.rateOffset=typeof this.option.rateOffset!="undefined"?this.option.rateOffset:0;this.maxReadyChk=typeof this.option.maxReadyChk!="undefined"?this.option.maxReadyChk:10;this.maxBufferedChk=typeof this.option.maxBufferedChk!="undefined"?this.option.maxBufferedChk:10;this.maxSeekSec=typeof this.option.maxSeekSec!="undefined"?this.option.maxSeekSec:8;this.maxBufferOverChk=typeof this.option.maxBufferOverChk!="undefined"?this.option.maxBufferOverChk:2;this.maxCurrentChk=typeof this.option.maxCurrentChk!="undefined"?this.option.maxCurrentChk:2;this.useNativeVolume=typeof this.option.useNativeVolume!="undefined"?this.option.useNativeVolume:false;this.defaultMuted=typeof this.option.defaultMuted!="undefined"?this.option.defaultMuted:true;this.useNativePlayer=typeof this.option.useNativePlayer!="undefined"?this.option.useNativePlayer:false;this.useProgramDateTime=typeof this.option.useProgramDateTime!="undefined"?this.option.useProgramDateTime:false;this.useTimeCode=typeof this.option.useTimeCode!="undefined"?this.option.useTimeCode:false;this.ProgramDateTimeType=typeof this.option.ProgramDateTimeType!="undefined"?this.option.ProgramDateTimeType:"manifest";if(this.useTimeCode===true){this.useProgramDateTime=false}function c(){if(typeof window!=="undefined"){var f=window.MediaSource||window.WebKitMediaSource}else{var f}var h=window.SourceBuffer||window.WebKitSourceBuffer;var i=f&&typeof f.isTypeSupported==="function"&&f.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"');var g=!h||h.prototype&&typeof h.prototype.appendBuffer==="function"&&typeof h.prototype.remove==="function";return !!i&&!!g}this.mseSupport=c();if(this.mseSupport===true){this.hlsSupport=true}else{this.hlsSupport=false;if(this.userAgent.indexOf("Android")>-1){this.useProgramDateTime=false;this.useTimeCode===false}}if(this.useNativePlayer===true){this.hlsSupport=false}if(this.hlsSupport===true&&this.disableSeek===false){this.maxSeekSec+=2}this.head=document.getElementsByTagName("head")[0];this.varObj=new Object();this.varObj.maxMaxBufferLength=500;this.varObj.maxBufferSize=50*1000*1000;this.varObj.fragLoadingMaxRetry=1;this.varObj.manifestLoadingMaxRetry=1;this.varObj.levelLoadingMaxRetry=0;this.varObj.liveSyncDurationCount=3;this.varObj.liveMaxLatencyDurationCount=4;this.varObj.initialLiveManifestSize=1;this.varObj.forceKeyFrameOnDiscontinuity=true;this.varObj.enableWebVTT=false;this.varObj.enableCEA708Captions=false;function b(){var f=true;if(typeof document.hidden!=="undefined"){this.vendorHidden="hidden";this.vendorVisibilityChange="visibilitychange"}else{if(typeof document.msHidden!=="undefined"){this.vendorHidden="msHidden";this.vendorVisibilityChange="msvisibilitychange"}else{if(typeof document.webkitHidden!=="undefined"){this.vendorHidden="webkitHidden";this.vendorVisibilityChange="webkitvisibilitychange"}else{f=false}}}return f}a.prototype.HttpClient=function(){this.get=function(h,f){var g=new XMLHttpRequest();g.onreadystatechange=function(){if(g.readyState==4&&g.status==200){var i=g.getResponseHeader("Last-Modified");if(i!=null){e.m3u8modify=new Date(i).getTime()}else{e.m3u8modify=null}f(g.responseText)}};g.open("GET",h,true);g.send(null)}};a.prototype.m3u8Parse=function(f){this.m3u8tag=f.split("#");this.programDateTime;for(var g in this.m3u8tag){if(this.m3u8tag[g].indexOf("EXT-X-PROGRAM-DATE-TIME")>-1){this.program=this.m3u8tag[g].split("\n");this.programDateTimeOrig=this.program[0].replace(/EXT-X-PROGRAM-DATE-TIME:/,"");if(this.programDateTimeOrig.split(":").length-1<3){this.insertValue=this.programDateTimeOrig.length-2;this.programDateTime=this.programDateTimeOrig.substr(0,this.insertValue)+":"+this.programDateTimeOrig.substr(-2)}else{this.programDateTime=this.programDateTimeOrig}}if(this.m3u8tag[g].indexOf("EXTINF")>-1){this.lastFragLengthArr=this.m3u8tag[g].split(",");this.lastFragLength=this.lastFragLengthArr[0].replace(/EXTINF:/,"")}}this.timeStamp=parseInt(new Date(this.programDateTime).getTime()+((this.lastFragLength/2)*1000)-(this.delayTime*1000));this.timecode=new Date(this.timeStamp)};a.prototype.m3u8URLParse=function(g){this.m3u8URLtag=g.split("#");this.firstLevel=null;for(var i in this.m3u8URLtag){if(this.m3u8URLtag[i].indexOf("EXT-X-STREAM-INF")>-1){this.firstLevelarr=this.m3u8URLtag[i].split("\n");for(var f in this.firstLevelarr){if(this.firstLevelarr[f].indexOf("m3u8")>-1){this.firstLevel=this.firstLevelarr[f];break}}}}if(this.firstLevel!=null){if(this.firstLevel.indexOf("http")>-1){this.m3u8Url=this.firstLevel}else{this.urlArr=this.url.split("/");var h=new RegExp(this.urlArr[this.urlArr.length-1],"g");this.m3u8Url=this.url.replace(h,this.firstLevel)}}else{this.m3u8Url=this.url}};a.prototype.m3u8LastEXTINFParse=function(f){this.m3u8LastEXTINFtag=f.split("#");this.lastFragLength=null;for(var g in this.m3u8LastEXTINFtag){if(this.m3u8LastEXTINFtag[g].indexOf("EXTINF")>-1){this.lastFragLengthArr=this.m3u8LastEXTINFtag[g].split(",");this.lastFragLengthTmp=this.lastFragLengthArr[0].replace(/EXTINF:/,"");this.lastFragLength=this.lastFragLengthTmp.split("\n")[0]}}if(this.lastFragLength!=null){this.lastFragInterval=parseFloat(this.lastFragLength)}else{this.lastFragInterval=null}};a.prototype.InitConnect=function(g,f,h){this.videoid=g;this.url=f;this.ResetChkVar();if(this.Player===null){this.Player=document.getElementById(g);this.Player.defaultMuted=this.defaultMuted;this.Player.muted=this.defaultMuted;this.lastSoundState=this.defaultMuted;if(this.iOS===false&&this.hlsSupport===true){this.hls=new Hls(this.varObj);this.HLSEvent()}else{this.ElementEvent()}}else{this.Player.defaultMuted=this.lastSoundState;this.Player.muted=this.lastSoundState}if(typeof h!=="undefined"){this.option.maxSeekSec=h;this.maxSeekSec=h;if(this.hlsSupport===true&&this.disableSeek===false){this.maxSeekSec=h+2}}if(this.Player!==null&&this.playState!==null){this.Restart(this.url)}else{this.Load(this.url)}};a.prototype.Mute=function(){if(this.Player&&this.useNativeVolume===false){if(this.Player.muted===false){this.Player.muted=true;this.lastSoundState=true;this.Player.defaultMuted=true}}};a.prototype.unMute=function(){if(this.Player&&this.useNativeVolume===false){if(this.Player.muted===true){this.Player.muted=false;this.lastSoundState=false;this.Player.defaultMuted=false}}};a.prototype.Pause=function(f){if(this.Player){if(this.Player.paused===false){this.Player.pause();this.manipause=true}}};a.prototype.Resume=function(){if(this.Player){if(this.Player.paused===true){this.Player.play();this.manipause=false}}};a.prototype.Load=function(f){if(this.Player!==null&&f!==null){if(this.iOS===true||this.hlsSupport===false){this.Player.src=f;this.Player.play();this.playState=true}else{this.hls.loadSource(f);this.hls.attachMedia(this.Player)}this.doSeek=setInterval(this.ChkBuf.bind(this),2000)}};a.prototype.Stop=function(){if(this.Player){if(this.playState===true){clearInterval(this.doSeek);if(this.iOS===true||this.hlsSupport===false){this.Pause()}else{this.Pause();this.hls.stopLoad();this.hls.detachMedia()}this.url=null;this.Player.src="";this.playState=false}this.ResetVar()}};a.prototype.PlaybackRate=function(f){if(this.Player){this.Player.playbackRate=f}};a.prototype.Volume=function(f){if(this.Player){this.Player.volume=f}};a.prototype.Seek=function(f){if(this.Player){this.Player.currentTime=f}};a.prototype.RateOffset=function(f){if(typeof f!=="undefined"&&isNaN(f)===true){this.rateOffset=f}};a.prototype.Restart=function(f){this.ResetChkVar();if(this.Player!==null){if(this.iOS===false&&this.hlsSupport===true){clearInterval(this.doSeek);this.ResetVar();if(this.hls!==null){this.hls.destroy()}this.playState=false;this.hls=new Hls(this.varObj);this.HLSEvent();this.hls.loadSource(f);this.hls.attachMedia(this.Player)}else{clearInterval(this.doSeek);this.ResetVar();this.Pause();this.Player.src="";this.playState=false;this.Player.src=f;this.Player.play();this.playState=true}this.doSeek=setInterval(this.ChkBuf.bind(this),2000)}};a.prototype.ChkBuf=function(){if(this.iOS===false&&this.hlsSupport===true){if(this.maniInitPTS===0&&this.fragParsingInit===1){this.Restart(this.url);return}}if(this.Player&&this.url!==null&&this.Player.readyState>0){this.bufferError=false;this.lastBuffer=this.bufferTime;this.lastCurrent=this.currentTime;this.bufferedLength=parseInt(this.Player.buffered.length)-1;if(this.bufferedLength<0){this.bufferedLength=0}try{this.bufferTime=parseFloat(this.Player.buffered.end(this.bufferedLength))}catch(f){this.bufferTime=0;this.bufferError=true}finally{if(this.bufferTime===0){this.bufferTime=this.lastBuffer}}this.currentTime=parseFloat(this.Player.currentTime);this.ready=this.Player.readyState;this.network=this.Player.networkState;if(this.bufferError===false){this.bufferTime=parseFloat(this.Player.buffered.end(this.bufferedLength));this.delayTime=this.bufferTime-this.currentTime;if(this.hlsSupport===true||this.iOS===true){this.ChkSeek()}}}if(this.iOS===true||this.hlsSupport===false){if(this.m3u8Url!==null){this.ChkCacheLoop(this.m3u8Url)}if(this.readyTimes===this.maxReadyChk){this.Restart(this.url);return}if(this.Player.readyState===0){this.readyTimes+=1}else{if(this.Player.readyState===1){this.readyTimes+=1}else{this.readyTimes=0}}}};a.prototype.ChkSeek=function(){if(this.Player&&this.delayTime!==0){switch(this.seekType){case"seek":if(this.delayTime>this.maxSeekSec+10){this.Restart(this.url);return}if(this.delayTime<0.5){this.Player.pause()}else{if(this.delayTime>4){if(this.manipause===false){this.Player.play()}}}if(this.delayTime>this.maxSeekSec){this.bufferTimes+=1}else{this.bufferTimes=0}if(this.bufferTimes>2){if(this.iOS===true){try{this.seekableEnd=this.Player.seekable.end(0)}catch(f){this.seekableEnd=0}if(this.seekableEnd>this.Player.currentTime){this.Seek(this.seekableEnd)}}else{if(this.hlsSupport===true){this.seekTime=this.delayTime-this.maxSeekSec;this.Seek(this.Player.currentTime+this.seekTime)}else{}}}break;case"rate":if(this.delayTime>this.maxSeekSec+2){this.Restart(this.url);return}if(this.delayTime>4){if(this.manipause===false){this.Player.play()}}if(this.delayTime-this.rateOffset>this.maxSeekSec/2+1){this.bufferTimes+=1}else{this.bufferTimes=0}if(this.bufferTimes>2){this.PlaybackRate(1.2)}else{this.PlaybackRate(1)}break;case"restart":if(this.Player.paused===true){if(this.delayTime>4){if(this.manipause===false){this.Player.play()}}}if(this.delayTime>this.maxSeekSec){this.bufferTimes+=1}else{this.bufferTimes=0}if(this.delayTime>this.maxSeekSec){if(this.bufferTimes>=this.maxBufferOverChk){this.Restart(this.url);return}}break;case"disable":break;default:break}if(this.lastTime>=this.maxBufferedChk){this.Restart(this.url);return}if(this.lastBuffer===this.bufferTime){this.lastTime+=1}else{this.lastTime=0}if(this.manipause===false){if(this.currentStopTimes>=this.currentChk){this.Restart(this.url)}if(this.lastCurrent===this.currentTime){this.currentStopTimes+=1}else{this.currentStopTimes=0}}else{this.currentStopTimes=0}}};a.prototype.ElementEventPlay=function(){if(this.Player){this.Player.onplay=function(){if(b()){document.addEventListener(vendorVisibilityChange,function(){if(document[vendorHidden]){e.hlsHidden=true;e.Pause()}else{e.hlsHidden=false;e.Resume()}})}}}};a.prototype.ChkCacheLoop=function(f){this.m3u8get=new this.HttpClient();var g=new Date().getTime();if(e.lastclientTime==0||(g-e.lastclientTime>2000)){this.m3u8get.get(f,function(h){e.basechk=btoa(h)});if(e.basechk===e.lastbasechk){e.basechktimes+=1}else{e.basechktimes=0}e.lastclientTime=g}this.lastbasechk=this.basechk};a.prototype.ElementEvent=function(){if(this.Player){this.Player.onerror=function(){e.errorcode="Error "+e.Player.error.code+"; details: "+e.Player.error.message;if(e.Player.error.code===4){e.Stop();e.errorcode="Error: Manifest 404 not found";e.errDetails="Manifest Load Error, Stop Stream"}};if(this.iOS===true&&this.hlsSupport===false){this.Player.onloadstart=function(){e.m3u8get=new e.HttpClient();e.m3u8get.get(e.url,function(f){e.m3u8URLParse(f)})};this.Player.onprogress=function(){if(e.useTimeCode===true){e.m3u8get=new e.HttpClient();e.m3u8get.get(e.m3u8Url,function(h){e.m3u8LastEXTINFParse(h)});if(e.lastFragInterval!=null&&e.delayTime>0){var f=parseFloat(e.Player.buffered.end(parseInt(e.Player.buffered.length)-1))-parseFloat(e.Player.currentTime);var g=e.timeStamp;if(e.m3u8modify!=null){e.timeStamp=e.m3u8modify-parseInt(f*1000);if(g>e.timeStamp){e.timeStamp=g}e.timecode=new Date(e.timeStamp)}else{e.timeStamp=parseInt(event.timeStamp-((f+(e.lastFragInterval/1.2))*1000));e.timecode=new Date(e.timeStamp)}}}if(e.useProgramDateTime===true){e.m3u8get=new e.HttpClient();e.m3u8get.get(e.m3u8Url,function(h){e.m3u8Parse(h)})}}}}};a.prototype.ResetVar=function(){this.bufferTime=0,this.currentTime=0,this.delayTime=0,this.seekTime=0,this.times=0,this.lastTime=0,this.lastBuffer=0,this.seekableEnd=0,this.lastCurrent=0,this.readyTimes=0,this.bufferTimes=0,this.currentStopTimes=0,this.errorcode="";this.maniLoading=0,this.maniLoaded=0,this.maniInitPTS=0,this.maniPaesed=0,this.fragParsingInit=0,this.manipause=false,this.inSeek=false,this.timecode=null,this.timeStamp=null,this.m3u8Url=null,this.lastFragInterval=null,this.m3u8modify=null};a.prototype.ResetChkVar=function(){this.lastbasechk="",this.basechk="",this.basechktimes=0,this.errDetails="",this.updateTimes=0};a.prototype.HLSEvent=function(){if(this.hls){this.error=this.hls.on(Hls.Events.ERROR,function(f,g){e.errorcode=g.details;if(g.fatal){switch(g.type){case Hls.ErrorTypes.NETWORK_ERROR:switch(g.details){case Hls.ErrorDetails.MANIFEST_LOAD_ERROR:e.errDetails="Manifest Load Error, Stop Stream";e.hls.recoverMediaError();break;case Hls.ErrorDetails.FRAG_LOAD_ERROR:e.errDetails="Manifest Load Timeout, Stream";e.hls.recoverMediaError();break;default:break}if(e.maniInitPTS!==0&&e.fragParsingInit!==1){e.ResetVar();e.hls.startLoad()}break;case Hls.ErrorTypes.MEDIA_ERROR:e.Restart(e.url);break;case Hls.ErrorTypes.OTHER_ERROR:break;default:e.hls.destroy();break}}else{switch(g.type){case Hls.ErrorTypes.NETWORK_ERROR:break;case Hls.ErrorTypes.MEDIA_ERROR:switch(g.details){case Hls.ErrorDetails.BUFFER_NUDGE_ON_STALL:e.ResetVar();e.hls.startLoad();break;default:break}break;case Hls.ErrorTypes.MUX_ERROR:break;case Hls.ErrorTypes.OTHER_ERROR:break;default:break}}});this.hls.on(Hls.Events.MANIFEST_LOADING,function(f,g){e.maniLoading=1});this.hls.on(Hls.Events.MANIFEST_LOADED,function(f,g){e.maniLoaded=1});this.hls.on(Hls.Events.MANIFEST_PARSED,function(){e.maniPaesed=1});this.hls.on(Hls.Events.LEVEL_LOADED,function(f,g){var h=new Date().getTime();if(e.lastclientTime==0||(h-e.lastclientTime>2000)){e.basechk=btoa(g.networkDetails.responseText);if(e.basechk===e.lastbasechk){e.basechktimes+=1}else{e.basechktimes=0}e.lastclientTime=h}if(e.basechktimes>=5){e.Stop();e.errorcode="Error: Griffinamas or SRS Temp Fragment Loop";e.errDetails="Fragment Loop"}e.lastbasechk=e.basechk;if(e.useProgramDateTime===true){if(e.ProgramDateTimeType==="manifest"){if(typeof g.details.programDateTime!="undefined"){this.fragDuration=(g.details.fragments[g.details.fragments.length-1].duration)*1000;e.timeStamp=new Date(g.details.programDateTime).getTime()+this.fragDuration;e.timecode=new Date(e.timeStamp)}}}});this.hls.on(Hls.Events.INIT_PTS_FOUND,function(f,g){e.maniInitPTS=1});this.hls.on(Hls.Events.FRAG_PARSING_INIT_SEGMENT,function(f,g){e.fragParsingInit=1;e.Player.play();e.playState=true});this.hls.on(Hls.Events.FRAG_CHANGED,function(f,g){if(e.useTimeCode===true){this.cTime=new Date().getTime();e.timeStamp=parseInt(this.cTime-(e.delayTime+(g.frag.duration/1.2))*1000);e.timecode=new Date(e.timeStamp)}if(e.useProgramDateTime===true){if(e.ProgramDateTimeType==="fragment"){if(typeof g.frag.programDateTime!="undefined"){this.fragDuration=g.frag.duration*1000;e.timeStamp=new Date(g.frag.rawProgramDateTime).getTime();e.timecode=new Date(e.timeStamp)}}}});this.hls.on(Hls.Events.FPS_DROP,function(f,g){});this.hls.on(Hls.Events.FPS_DROP_LEVEL_CAPPING,function(f,g){});this.hls.on(Hls.Events.DESTROYING,function(f,g){})}}};return a}();